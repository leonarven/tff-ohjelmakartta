<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TFF2026 Ohjelmakartta</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 100%;
            overflow-x: auto;
        }

        .header {
            background: #2a2a2a;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .header h1 {
            margin-bottom: 10px;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .stat-item {
            background: #3a3a3a;
            padding: 10px 20px;
            border-radius: 4px;
        }

        .stat-item.warning {
            background: #b34700;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        button {
            background: #4a4a4a;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background: #5a5a5a;
        }

        .grid-wrapper {
            position: relative;
            overflow-x: auto;
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
        }

        .day-section {
            margin-bottom: 40px;
        }

        .day-header {
            background: #3a3a3a;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 18px;
        }

        .schedule-grid {
            display: grid;
            gap: 2px;
            min-width: fit-content;
        }

        /* Dynaamiset sarakkeet lasketaan JavaScriptill√§ */
        .time-column {
            padding: 10px;
            background: #3a3a3a;
            text-align: center;
            font-weight: bold;
            min-width: 60px;
        }

        .venue-header {
            background: #4a4a4a;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            font-size: 12px;
            min-width: 150px;
        }

        .time-row {
            background: #3a3a3a;
            padding: 5px;
            text-align: center;
            font-size: 12px;
            min-width: 60px;
        }

        .screening-cell {
            min-height: 40px;
            position: relative;
            min-width: 150px;
        }

        .screening-box {
            position: absolute;
            left: 2px;
            right: 2px;
            padding: 4px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            overflow: hidden;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .screening-box:hover {
            transform: scale(1.02);
            z-index: 100;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
        }

        .screening-box.selected {
            border: 3px solid #ffff00;
            box-shadow: 0 0 10px rgba(255,255,0,0.5);
        }

        .screening-box.conflict {
            border: 3px solid #ff0000;
            box-shadow: 0 0 10px rgba(255,0,0,0.5);
        }

        .screening-title {
            font-weight: bold;
            margin-bottom: 2px;
        }

        .screening-code {
            opacity: 0.8;
            font-size: 9px;
        }

        .screening-time {
            opacity: 0.7;
            font-size: 9px;
        }

        /* V√§rikoodit sarjoille */
        .series-IK { background: #4a7ba7; }
        .series-KK { background: #5a8fb7; }
        .series-GXYZ { background: #6a9fc7; }
        .series-AA { background: #4a9a4a; }
        .series-UK { background: #b8a83c; }
        .series-RR { background: #8a5a9a; }
        .series-UH-RET { background: #9a6aaa; }
        .series-UH-CB { background: #aa7aba; }
        .series-ESFAA { background: #7a9aba; }
        .series-ESFP { background: #8aaaca; }
        .series-KAA { background: #6a8a9a; }
        .series-PCH { background: #ca8a5a; }
        .series-ELO { background: #da9a6a; }
        .series-KTAMK { background: #ea aa7a; }
        .series-MK { background: #5a9a8a; }
        .series-PEL { background: #9a7a6a; }
        .series-ERIK { background: #7a6a8a; }
        .series-WAV { background: #6a8a7a; }

        .free-screening {
            border: 2px solid #00ff00;
        }

        .selected-list {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .selected-item {
            background: #3a3a3a;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .remove-btn {
            background: #b34700;
            padding: 5px 10px;
            font-size: 12px;
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé¨ TFF2026 Ohjelmakartta</h1>
            
            <div class="stats">
                <div class="stat-item">
                    <strong>Valittu:</strong> <span id="selected-count">0</span> n√§yt√∂st√§
                </div>
                <div class="stat-item" id="paid-counter">
                    <strong>Maksullisia:</strong> <span id="paid-count">0</span> / 10
                </div>
                <div class="stat-item" id="conflict-warning" style="display: none;">
                    ‚ö†Ô∏è P√§√§llekk√§isyyksi√§ havaittu!
                </div>
            </div>

            <div class="controls">
                <button onclick="exportSelection()">üì• Vie valinnat (JSON)</button>
                <button onclick="importSelection()">üì§ Tuo valinnat</button>
                <button onclick="clearSelection()">üóëÔ∏è Tyhjenn√§ valinnat</button>
            </div>

            <div class="legend" id="legend"></div>
        </div>

        <div class="grid-wrapper" id="schedule-container"></div>

        <div class="selected-list">
            <h2>Valitut n√§yt√∂kset</h2>
            <div id="selected-screenings"></div>
        </div>
    </div>

    <script>
        // Ladataan festivaalidata (t√§m√§ korvataan oikealla datalla)
        let festivalData = null;
        let selectedScreenings = [];
        let venuesPerDay = {}; // Tallentaa kunkin p√§iv√§n sijaintim√§√§r√§n

        // Ladataan data ja alustetaan sovellus
        async function init() {
            try {
                // T√§ss√§ ladattaisiin oikea data
                festivalData = await fetchFestivalData();
                loadFromLocalStorage();
                renderSchedule();
                updateStats();
            } catch (error) {
                console.error('Virhe datan lataamisessa:', error);
            }
        }

	async function fetchFestivalData() {
		const STORAGE_KEY_FESTIVAL_DATA = "tff2026_festival_data";

		let data;

		try {
			if (!(new URLSearchParams(location.search)).get("reset")) {
				data = JSON.parse( localStorage.getItem( STORAGE_KEY_FESTIVAL_DATA ));
			}
		} catch (error) {
			console.warn( error );
		}

		if (!data) {
			data = await (await fetch("/data.json")).json();
			localStorage.setItem( STORAGE_KEY_FESTIVAL_DATA, JSON.stringify( data ) );
		}

		if (!data) throw new Error( "Unable to fetch festivalData!" );

		return data;
	}

        function renderSchedule() {
            const container = document.getElementById('schedule-container');
            container.innerHTML = '';

            // Ryhmitell√§√§n n√§yt√∂kset p√§ivitt√§in
            const screeningsByDay = groupScreeningsByDay();

            // Luodaan legenda
            renderLegend();

            // Render√∂id√§√§n jokaiselle p√§iv√§lle oma osio
            Object.keys(screeningsByDay).sort().forEach(date => {
                const daySection = document.createElement('div');
                daySection.className = 'day-section';

                const dayHeader = document.createElement('div');
                dayHeader.className = 'day-header';
                dayHeader.textContent = formatDate(date);
                daySection.appendChild(dayHeader);

                const dayGrid = renderDayGrid(date, screeningsByDay[date]);
                daySection.appendChild(dayGrid);

                container.appendChild(daySection);
            });
        }

        function groupScreeningsByDay() {
            const groups = {};
            
            festivalData.screenings.forEach(screening => {
                const date = screening.datetime_start.split('T')[0];
                if (!groups[date]) {
                    groups[date] = [];
                }
                groups[date].push(screening);
            });

            return groups;
        }

        function renderDayGrid(date, screenings) {
            const grid = document.createElement('div');
            grid.className = 'schedule-grid';

            // Laske kuinka monta sijaintia on k√§yt√∂ss√§ t√§n√§ p√§iv√§n√§
            const venuesForDay = getVenuesForDay(screenings);
            venuesPerDay[date] = venuesForDay;
            const venueCount = venuesForDay.length;

            // Aseta grid-sarakkeet dynaamisesti: 1 aikasarake + N sijaintia
            grid.style.gridTemplateColumns = `60px repeat(${venueCount}, 1fr)`;

            // Render√∂i header-rivi
            renderGridHeader(grid, venuesForDay);

            // Luo aikaruudukko (9:00 - 24:00)
            const timeSlots = generateTimeSlots();
            
            timeSlots.forEach(time => {
                // Aikasarake
                const timeCell = document.createElement('div');
                timeCell.className = 'time-row';
                timeCell.textContent = time;
                grid.appendChild(timeCell);

                // Sijaintisolut
                venuesForDay.forEach(venue => {
                    const cell = document.createElement('div');
                    cell.className = 'screening-cell';
                    cell.dataset.time = time;
                    cell.dataset.venue = venue.venue_id;
                    cell.dataset.date = date;

                    // Lis√§√§ n√§yt√∂kset jotka alkavat t√§m√§n tunnin aikana
                    const cellScreenings = getScreeningsForCell(date, venue.venue_id, time, screenings);
                    cellScreenings.forEach(screening => {
                        const box = createScreeningBox(screening);
                        cell.appendChild(box);
                    });

                    grid.appendChild(cell);
                });
            });

            return grid;
        }

        function getVenuesForDay(screenings) {
            // Kerr√§√§ uniikit sijainnit jotka ovat k√§yt√∂ss√§ n√§iss√§ n√§yt√∂ksiss√§
            const venueIds = [...new Set(screenings.map(s => s.venue_id))];
            return festivalData.venues.filter(v => venueIds.includes(v.venue_id));
        }

        function renderGridHeader(grid, venues) {
            // Tyhj√§ kulma-solu
            const corner = document.createElement('div');
            corner.className = 'time-column';
            corner.textContent = '';
            grid.appendChild(corner);

            // Sijaintiotsikot
            venues.forEach(venue => {
                const header = document.createElement('div');
                header.className = 'venue-header';
                header.textContent = venue.name.replace('Finnkino Cine Atlas ', 'CA');
                grid.appendChild(header);
            });
        }

        function generateTimeSlots() {
            const slots = [];
            for (let hour = 9; hour <= 23; hour++) {
                slots.push(`${hour.toString().padStart(2, '0')}:00`);
            }
            return slots;
        }

        function getScreeningsForCell(date, venueId, timeSlot, screenings) {
            const [hour] = timeSlot.split(':');
            const slotStart = parseInt(hour);
            
            return screenings.filter(s => {
                if (s.venue_id !== venueId) return false;
                
                const startTime = new Date(s.datetime_start);
                const startHour = startTime.getHours();
                
                return startHour === slotStart;
            });
        }

        function createScreeningBox(screening) {
            const box = document.createElement('div');
            box.className = `screening-box series-${screening.series_id}`;
            
            if (screening.is_free) {
                box.classList.add('free-screening');
            }

            const startTime = new Date(screening.datetime_start);
            const hours = startTime.getHours();
            const minutes = startTime.getMinutes();
            
            // Laske position ja korkeus
            const topOffset = (minutes / 60) * 40; // 40px per tunti
            const heightPx = (screening.duration_minutes / 60) * 40;
            
            box.style.top = `${topOffset}px`;
            box.style.height = `${heightPx}px`;

            box.innerHTML = `
                <div class="screening-title">${screening.title}</div>
                <div class="screening-code">${screening.ticket_code || screening.screening_id}</div>
                <div class="screening-time">${formatTime(screening.datetime_start)} | ${screening.duration_minutes} min</div>
            `;

            box.onclick = () => toggleScreening(screening.screening_id);

            // P√§ivit√§ valinta-status
            if (selectedScreenings.includes(screening.screening_id)) {
                box.classList.add('selected');
            }

            return box;
        }

        function toggleScreening(screeningId) {
            const index = selectedScreenings.indexOf(screeningId);
            
            if (index > -1) {
                selectedScreenings.splice(index, 1);
            } else {
                selectedScreenings.push(screeningId);
            }

            saveToLocalStorage();
            renderSchedule();
            updateStats();
            updateSelectedList();
        }

        function updateStats() {
            const selectedCount = selectedScreenings.length;
            const paidCount = selectedScreenings.filter(id => {
                const screening = festivalData.screenings.find(s => s.screening_id === id);
                return screening && !screening.is_free;
            }).length;

            document.getElementById('selected-count').textContent = selectedCount;
            document.getElementById('paid-count').textContent = paidCount;

            const paidCounter = document.getElementById('paid-counter');
            if (paidCount > 10) {
                paidCounter.classList.add('warning');
            } else {
                paidCounter.classList.remove('warning');
            }

            // Tarkista p√§√§llekk√§isyydet
            const hasConflicts = checkConflicts();
            document.getElementById('conflict-warning').style.display = hasConflicts ? 'block' : 'none';
        }

        function checkConflicts() {
            const selected = selectedScreenings.map(id => 
                festivalData.screenings.find(s => s.screening_id === id)
            ).filter(Boolean);

            for (let i = 0; i < selected.length; i++) {
                for (let j = i + 1; j < selected.length; j++) {
                    if (screeningsOverlap(selected[i], selected[j])) {
                        // Merkitse konfliktit
                        document.querySelectorAll('.screening-box').forEach(box => {
                            const title = box.querySelector('.screening-title')?.textContent;
                            if (title === selected[i].title || title === selected[j].title) {
                                box.classList.add('conflict');
                            }
                        });
                        return true;
                    }
                }
            }

            document.querySelectorAll('.screening-box.conflict').forEach(box => {
                box.classList.remove('conflict');
            });
            return false;
        }

        function screeningsOverlap(s1, s2) {
            const start1 = new Date(s1.datetime_start);
            const end1 = new Date(s1.datetime_end);
            const start2 = new Date(s2.datetime_start);
            const end2 = new Date(s2.datetime_end);

            return (start1 < end2 && end1 > start2);
        }

        function updateSelectedList() {
            const container = document.getElementById('selected-screenings');
            container.innerHTML = '';

            if (selectedScreenings.length === 0) {
                container.innerHTML = '<p style="opacity: 0.5;">Ei valittuja n√§yt√∂ksi√§</p>';
                return;
            }

            const selected = selectedScreenings.map(id => 
                festivalData.screenings.find(s => s.screening_id === id)
            ).filter(Boolean).sort((a, b) => 
                new Date(a.datetime_start) - new Date(b.datetime_start)
            );

            selected.forEach(screening => {
                const item = document.createElement('div');
                item.className = 'selected-item';
                item.innerHTML = `
                    <div>
                        <strong>${screening.title}</strong><br>
                        <small>${formatDateTime(screening.datetime_start)} | ${screening.venue_name} | ${screening.duration_minutes} min ${screening.is_free ? '(ILMAINEN)' : ''}</small>
                    </div>
                    <button class="remove-btn" onclick="toggleScreening('${screening.screening_id}')">Poista</button>
                `;
                container.appendChild(item);
            });
        }

        function renderLegend() {
            const legend = document.getElementById('legend');
            const series = [...new Set(festivalData.screenings.map(s => s.series_id))];

            legend.innerHTML = series.map(seriesId => {
                const seriesInfo = festivalData.series_definitions?.find(s => s.series_id === seriesId);
                return `
                    <div class="legend-item">
                        <div class="legend-color series-${seriesId}"></div>
                        <span>${seriesInfo?.name || seriesId}</span>
                    </div>
                `;
            }).join('');
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const days = ['Su', 'Ma', 'Ti', 'Ke', 'To', 'Pe', 'La'];
            return `${days[date.getDay()]} ${date.getDate()}.${date.getMonth() + 1}.`;
        }

        function formatTime(datetimeString) {
            const date = new Date(datetimeString);
            return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        }

        function formatDateTime(datetimeString) {
            return `${formatDate(datetimeString.split('T')[0])} ${formatTime(datetimeString)}`;
        }

        function saveToLocalStorage() {
            localStorage.setItem('tff2026_selections', JSON.stringify(selectedScreenings));
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('tff2026_selections');
            if (saved) {
                selectedScreenings = JSON.parse(saved);
            }
        }

        function exportSelection() {
            const data = {
                selections: selectedScreenings,
                timestamp: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tff2026_selections_${Date.now()}.json`;
            a.click();
        }

        function importSelection() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        selectedScreenings = data.selections || [];
                        saveToLocalStorage();
                        renderSchedule();
                        updateStats();
                        updateSelectedList();
                        alert('Valinnat tuotu onnistuneesti!');
                    } catch (error) {
                        alert('Virhe tiedoston lukemisessa!');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function clearSelection() {
            if (confirm('Haluatko varmasti tyhjent√§√§ kaikki valinnat?')) {
                selectedScreenings = [];
                saveToLocalStorage();
                renderSchedule();
                updateStats();
                updateSelectedList();
            }
        }

        // K√§ynnist√§ sovellus
        init();
    </script>
</body>
</html>
